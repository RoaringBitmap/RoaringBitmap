name: Publish release

on:
  push:
    tags:
      - '[0-9]*.[0-9]*.[0-9]*' # GitHub Actions tag filters use glob patterns (not regex).

concurrency:
  group: publish-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish-maven-central:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    if: github.repository == 'RoaringBitmap/RoaringBitmap'
    environment: release
    timeout-minutes: 240
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: '0'

      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-disabled: true
          validate-wrappers: true

      - name: Validate required publish secrets
        env:
          HAS_GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY != '' }}
          HAS_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE != '' }}
          HAS_MAVEN_USER: ${{ secrets.MAVEN_USER != '' }}
          HAS_MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD != '' }}
        run: |
          set -euo pipefail
          for var in HAS_GPG_PRIVATE_KEY HAS_GPG_PASSPHRASE HAS_MAVEN_USER HAS_MAVEN_PASSWORD; do
            if [ "${!var}" != "true" ]; then
              echo "::error::Missing required secret: ${var#HAS_}"
              exit 1
            fi
          done

      - name: Resolve and validate release version
        run: |
          set -euo pipefail
          if ! [[ "$GITHUB_REF_NAME" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Release tag must match X.Y.Z. Got '$GITHUB_REF_NAME'"
            exit 1
          fi
          GRADLE_VERSION="$(sed -nE 's/^version[[:space:]]*=[[:space:]]*([^[:space:]]+).*/\1/p' gradle.properties | head -n1)"
          if [ -z "$GRADLE_VERSION" ]; then
            echo "::error::Unable to read 'version' from gradle.properties"
            exit 1
          fi
          if ! [[ "$GRADLE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?$ ]]; then
            echo "::error::gradle.properties version must be X.Y.Z or X.Y.Z-SNAPSHOT. Got '$GRADLE_VERSION'"
            exit 1
          fi
          PUBLISH_VERSION="${GRADLE_VERSION%-SNAPSHOT}"
          if [[ "$PUBLISH_VERSION" == *-SNAPSHOT ]]; then
            echo "::error::Release version cannot end with -SNAPSHOT"
            exit 1
          fi
          if [ "$GITHUB_REF_NAME" != "$PUBLISH_VERSION" ]; then
            echo "::error::Tag '$GITHUB_REF_NAME' does not match release version '$PUBLISH_VERSION' derived from gradle.properties ($GRADLE_VERSION)"
            exit 1
          fi
          echo "Publishing release version: $PUBLISH_VERSION"
          echo "PUBLISH_VERSION=$PUBLISH_VERSION" >> "$GITHUB_ENV"

      - name: Publish Maven artifacts
        env:
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.GPG_PRIVATE_KEY }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.GPG_PASSPHRASE }}
          ORG_GRADLE_PROJECT_sonatypeUsername: ${{ secrets.MAVEN_USER }}
          ORG_GRADLE_PROJECT_sonatypePassword: ${{ secrets.MAVEN_PASSWORD }}
        run: |
          set -euo pipefail
          ARGS=(publishAggregationToCentralPortal --no-scan --info)
          ARGS+=("-Pversion=$PUBLISH_VERSION")
          ./gradlew "${ARGS[@]}"
